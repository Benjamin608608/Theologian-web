<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
  const GOOGLE_CLIENT_ID = '819177680816-qhqs26nalisihdnducd35so1g4ai66rv.apps.googleusercontent.com';
  let currentUser = null;

  window.onload = function () {
    document.querySelector('.main-content').style.display = 'none';
    renderGoogleLogin();
  };

  function renderGoogleLogin() {
    const header = document.querySelector('.header');
    const loginBox = document.createElement('div');
    loginBox.id = 'googleSignInButton';
    loginBox.style.margin = '1.5rem auto';
    loginBox.style.display = 'flex';
    loginBox.style.justifyContent = 'center';
    header.appendChild(loginBox);

    setTimeout(() => {
      if (typeof google !== 'undefined' && google.accounts) {
        google.accounts.id.initialize({
          client_id: GOOGLE_CLIENT_ID,
          callback: handleSignIn
        });
        google.accounts.id.renderButton(
          document.getElementById('googleSignInButton'),
          { theme: 'outline', size: 'large' }
        );
      } else {
        console.error('Google 登入初始化失敗');
      }
    }, 500);
  }

  function handleSignIn(response) {
    try {
      const payload = JSON.parse(atob(response.credential.split('.')[1]));
      currentUser = {
        name: payload.name,
        email: payload.email,
        picture: payload.picture
      };
      document.getElementById('googleSignInButton')?.remove();
      document.querySelector('.main-content').style.display = 'grid';
      renderLogout();
    } catch (e) {
      console.error('登入處理錯誤：', e);
    }
  }

  function renderLogout() {
    const header = document.querySelector('.header');
    const userDiv = document.createElement('div');
    userDiv.style.marginTop = '1rem';
    userDiv.style.display = 'flex';
    userDiv.style.alignItems = 'center';
    userDiv.style.justifyContent = 'center';
    userDiv.style.gap = '1rem';

    const avatar = document.createElement('img');
    avatar.src = currentUser.picture;
    avatar.alt = '頭像';
    avatar.style.width = '36px';
    avatar.style.height = '36px';
    avatar.style.borderRadius = '50%';

    const name = document.createElement('span');
    name.textContent = currentUser.name;
    name.style.color = 'white';
    name.style.fontWeight = 'bold';

    const logoutBtn = document.createElement('button');
    logoutBtn.textContent = '登出';
    logoutBtn.style.marginLeft = '10px';
    logoutBtn.style.padding = '6px 12px';
    logoutBtn.style.borderRadius = '6px';
    logoutBtn.style.border = 'none';
    logoutBtn.style.cursor = 'pointer';
    logoutBtn.style.background = '#ffffffaa';
    logoutBtn.style.color = '#333';
    logoutBtn.onclick = () => {
      google.accounts.id.disableAutoSelect();
      location.reload();
    };

    userDiv.appendChild(avatar);
    userDiv.appendChild(name);
    userDiv.appendChild(logoutBtn);
    header.appendChild(userDiv);
  }
</script>
